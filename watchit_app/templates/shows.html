{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid page-container mb-5">
    <h2 class="section-title">TOP SHOWS</h2>

    <div class="carousel-container mt-4">
        <div class="carousel-scroll two-rows" id="shows-scroll">
            {% for show in shows %}
            {% if show.Poster != 'N/A' and show.Poster %}
            <div class="media-card fade-in visible">
                <a href="{% url 'detail' show.imdbID %}">
                    <img src="{{ show.Poster }}" alt="{{ show.Title }}" loading="lazy">
                    <div class="media-info">
                        <div class="media-title">{{ show.Title }}</div>
                        <div class="media-meta">{{ show.Year }}</div>
                    </div>
                </a>
            </div>
            {% endif %}
            {% endfor %}
            <div id="loader" class="d-flex align-items-center justify-content-center"
                style="min-width: 100px; display: none !important;">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    let isLoading = false;
    let hasNext = true;
    const scrollContainer = document.getElementById('shows-scroll');
    const loader = document.getElementById('loader');

    scrollContainer.addEventListener('scroll', () => {
        if (isLoading || !hasNext) return;

        if (scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 200) {
            loadMoreShows();
        }
    });

    async function loadMoreShows() {
        isLoading = true;
        loader.style.setProperty('display', 'flex', 'important');
        currentPage++;

        try {
            const response = await fetch(`/fetch-more/?category=shows&page=${currentPage}`);
            const data = await response.json();

            if (data.items && data.items.length > 0) {
                data.items.forEach(show => {
                    const card = document.createElement('div');
                    card.className = 'media-card fade-in visible';
                    card.innerHTML = `
                        <a href="/watch/${show.imdbID}/">
                            <img src="${show.Poster}" alt="${show.Title}" loading="lazy">
                            <div class="media-info">
                                <div class="media-title">${show.Title}</div>
                                <div class="media-meta">${show.Year}</div>
                            </div>
                        </a>
                    `;
                    scrollContainer.insertBefore(card, loader);
                });
            }

            hasNext = data.has_next;
        } catch (error) {
            console.error('Error fetching more shows:', error);
        } finally {
            isLoading = false;
            loader.style.setProperty('display', 'none', 'important');
        }
    }
</script>
{% endblock %}