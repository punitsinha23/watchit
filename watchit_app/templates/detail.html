{% extends 'base.html' %}
{% load static %}

{% block title %}{{ movie.Title }} - WATCHIT{% endblock %}

{% block content %}
<div class="container mt-5 fade-in">

    <!-- Player Section (Visible by Default) -->
    <div id="player-section" class="mb-5 player-offset">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="player-container position-relative bg-black rounded overflow-hidden shadow-lg"
                    style="padding-bottom: 56.25%; height: 0;">
                    <iframe id="video-player" src=""
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                        allowfullscreen></iframe>
                </div>

                <!-- Series Controls & Source Selection -->
                <div class="d-flex flex-wrap gap-3 align-items-center mt-3 p-3 rounded bg-dark">
                    <!-- Source Selection -->
                    <div class="flex-grow-1">
                        <label class="text-secondary small mb-1">Source</label>
                        <select id="source-select" class="form-select bg-dark text-white border-secondary">
                            <option value="vidsrc">Server 1 (Vidsrc.xyz)</option>
                            <option value="vidsrcto">Server 2 (Vidsrc.to)</option>
                            <option value="vidsrcme">Server 3 (Vidsrc.me)</option>
                            <option value="superembed">Server 4 (SuperEmbed)</option>
                        </select>
                    </div>

                    {% if movie.Type == 'series' %}
                    <div class="flex-grow-1">
                        <label class="text-secondary small mb-1">Season</label>
                        <select id="season-select" class="form-select bg-dark text-white border-secondary">
                            {% for i in "x"|rjust:movie.totalSeasons %}
                            <option value="{{ forloop.counter }}">Season {{ forloop.counter }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex-grow-1">
                        <label class="text-secondary small mb-1">Episode</label>
                        <select id="episode-select" class="form-select bg-dark text-white border-secondary">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Info Section (Simple Layout) -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h1 class="display-4 fw-bold text-white mb-3">{{ movie.Title }}</h1>

            <div class="d-flex align-items-center gap-3 mb-4 text-secondary">
                <span class="badge bg-danger">{{ movie.Rated }}</span>
                <span>{{ movie.Year }}</span>
                <span>{{ movie.Runtime }}</span>
                <span class="text-success"><i class="fas fa-star me-1"></i>{{ movie.imdbRating }}</span>
            </div>

            <p class="lead text-white-50 mb-4">{{ movie.Plot }}</p>

            <div class="text-secondary small">
                <p><strong>Genre:</strong> <span class="text-white">{{ movie.Genre }}</span></p>
                <p><strong>Director:</strong> <span class="text-white">{{ movie.Director }}</span></p>
                <p><strong>Cast:</strong> <span class="text-white">{{ movie.Actors }}</span></p>
            </div>
        </div>
    </div>

    <hr class="border-secondary opacity-25 my-5">

    <!-- Recommendations -->
    <h2 class="section-title ps-4">You Might Also Like</h2>
    <div class="media-grid">
        {% for rec in recommendations %}
        <div class="movie-unit fade-in visible">
            <div class="premium-card">
                <img src="{{ rec.Poster }}" alt="{{ rec.Title }}" loading="lazy">
                <div class="premium-overlay">
                    <a href="{% url 'detail' rec.imdbID %}" class="premium-btn premium-btn-play">
                        <i class="fas fa-play me-2"></i>Play
                    </a>
                    <form method="POST" action="{% url 'add_to_watchlist' %}" class="d-inline w-100">
                        {% csrf_token %}
                        <input type="hidden" name="imdb_id" value="{{ rec.imdbID }}">
                        <input type="hidden" name="title" value="{{ rec.Title }}">
                        <input type="hidden" name="year" value="{{ rec.Year }}">
                        <input type="hidden" name="poster" value="{{ rec.Poster }}">
                        <button type="submit" class="premium-btn premium-btn-list">
                            <i class="fas fa-plus me-2"></i>My List
                        </button>
                    </form>
                </div>
            </div>
            <div class="media-info text-center">
                <div class="media-title">{{ rec.Title }}</div>
                <div class="media-meta">{{ rec.Year }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .display-none {
        display: none !important;
    }

    .clamp-text {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .player-offset {
        margin-top: 20px;
        /* increase if navbar is taller */
    }
</style>

<!-- Episode data passed via JSON script tag -->
<script id="episodes-data" type="application/json">
    {{ episodes_json|safe }}
</script>
<script>
    const imdbId = "{{ movie.imdbID }}";
    const type = "{{ movie.Type }}";
    const player = document.getElementById('video-player');
    const sourceSelect = document.getElementById('source-select');

    let currentSeason = 1;
    let currentEpisode = 1;
    let currentSource = 'vidsrc';

    function getSourceUrl(source, type, id, season, episode) {
        if (source === 'vidsrcto') {
            if (type === 'movie') {
                return `https://vidsrc.to/embed/movie/${id}`;
            } else {
                return `https://vidsrc.to/embed/tv/${id}/${season}/${episode}`;
            }
        } else if (source === 'vidsrcme') {
            if (type === 'movie') {
                return `https://vidsrc.me/embed/${id}`;
            } else {
                return `https://vidsrc.me/embed/tv/${id}/season/${season}/episode/${episode}`;
            }
        } else if (source === 'superembed') {
            if (type === 'movie') {
                return `https://seapi.link/?type=imdb&id=${id}`;
            } else {
                return `https://seapi.link/?type=imdb&id=${id}&season=${season}&episode=${episode}`;
            }
        } else {
            // Default to vidsrc.xyz
            if (type === 'movie') {
                return `https://vidsrc.xyz/embed/movie/${id}`;
            } else {
                return `https://vidsrc.xyz/embed/tv/${id}/${season}/${episode}`;
            }
        }
    }

    function updatePlayer() {
        player.src = getSourceUrl(currentSource, type, imdbId, currentSeason, currentEpisode);
    }

    document.addEventListener('DOMContentLoaded', function () {

        // Initialize player
        updatePlayer();

        sourceSelect.addEventListener('change', function () {
            currentSource = this.value;
            updatePlayer();
        });

        if (type === 'movie') {
            return;
        }

        const seasonSelect = document.getElementById('season-select');
        const episodeSelect = document.getElementById('episode-select');

        // Load Season 1 initially
        loadSeason(1);

        seasonSelect.addEventListener('change', function () {
            currentSeason = this.value;
            loadSeason(currentSeason);
        });

        episodeSelect.addEventListener('change', function () {
            currentEpisode = this.value;
            updatePlayer();
        });

        function loadSeason(season) {
            fetch(`https://www.omdbapi.com/?apikey={{ api_key }}&i=${imdbId}&Season=${season}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.Episodes) {
                        episodeSelect.innerHTML = '<option>No episodes</option>';
                        return;
                    }

                    episodeSelect.innerHTML = '';
                    data.Episodes.forEach(ep => {
                        const opt = document.createElement('option');
                        opt.value = ep.Episode;
                        opt.textContent = `Episode ${ep.Episode}: ${ep.Title}`;
                        episodeSelect.appendChild(opt);
                    });

                    currentEpisode = data.Episodes[0].Episode;
                    updatePlayer();
                })
                .catch(() => {
                    episodeSelect.innerHTML = '<option>Error loading episodes</option>';
                });
        }
    });
</script>

{% endblock %}