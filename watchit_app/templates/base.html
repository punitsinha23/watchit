{% load static %}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}WATCHIT{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600&family=Oswald:wght@200..700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <style>
        body {
            background-color: #141414;
            color: #fff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow-x: hidden;
            padding-top: 80px;
            /* Navbar height compensation */
        }

        .navbar {
            background-color: #000 !important;
            border-bottom: 1px solid #333;
        }

        /* Mobile menu background */
        @media (max-width: 991.98px) {
            .navbar-collapse {
                background-color: #000;
                padding: 1rem;
                margin-top: 1rem;
                border-radius: 8px;
            }
        }

        .navbar-brand {
            color: #e50914 !important;
            font-size: 1.75rem;
            font-family: "Bebas Neue", serif;
        }

        .nav-link {
            color: #fff !important;
            margin-right: 15px;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: #e50914 !important;
        }

        /* Hero Section Improvements */
        .hero-section {
            height: 80vh;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        /* Gradient Overlay */
        .hero-section::after {
            content: '';
            position: absolute;
            top: 10;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, #141414 0%, rgba(20, 20, 20, 0.6) 50%, rgba(20, 20, 20, 0.4) 100%);
        }

        .hero-content {
            position: absolute;
            bottom: 25%;
            left: 5%;
            z-index: 2;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .hero-content h1 {
            font-family: 'Bebas Neue', serif;
            font-size: 4rem;
            margin-bottom: 1rem;
        }


        /* Horizontal Scroll Containers */
        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            padding: 20px 0;
        }

        .carousel-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding-bottom: 20px;
            /* Hide scrollbar spacing */
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .carousel-scroll::-webkit-scrollbar {
            display: none;
        }

        .movie-box {
            flex: 0 0 auto;
            width: 160px;
            background: transparent;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }

        .movie-box img {
            width: 100%;
            border-radius: 8px;
            display: block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .movie-box:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .section-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 4px solid #e50914;
        }

        /* Free Trial Modal Styles */
        .trial-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .trial-modal-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid #e50914;
            border-radius: 20px;
            padding: 3rem 2.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(229, 9, 20, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .trial-modal h2 {
            color: #e50914;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .trial-modal p {
            color: #fff;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .trial-timer {
            background: rgba(229, 9, 20, 0.2);
            border: 1px solid #e50914;
            border-radius: 10px;
            padding: 1rem;
            margin: 1.5rem 0;
            font-size: 1.3rem;
            color: #e50914;
            font-weight: bold;
        }

        .trial-modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .trial-modal-buttons button {
            flex: 1;
            min-width: 140px;
            padding: 0.9rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .trial-btn-signup {
            background: #e50914;
            color: white;
        }

        .trial-btn-signup:hover {
            background: #b8070e;
            transform: scale(1.05);
        }

        .trial-btn-login {
            background: transparent;
            color: white;
            border: 2px solid #fff;
        }

        .trial-btn-login:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        /* Loading Bar CSS */
        #loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: linear-gradient(90deg, #e50914, #ff00cc);
            z-index: 11000;
            transition: width 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 0 10px rgba(229, 9, 20, 0.5);
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="loading-bar"></div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top shadow-sm"
        style="border-bottom: 1px solid #333;">
        <div class="container-fluid px-lg-4 d-flex align-items-center">
            <a class="navbar-brand" href="{% url 'base' %}">WATCHIT</a>

            <!-- Search Bar - Always Visible -->
            <div class="ms-auto me-2">
                <form method="POST" action="{% url 'user_dashboard' %}" class="search-box">
                    {% csrf_token %}
                    <i class="fa fa-search search-icon"></i>
                    <input class="search-input" type="text" name="title" placeholder="Search...">
                </form>
            </div>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center">
                    {% if user.is_authenticated %}
                    <li class="nav-item d-lg-none">
                        <a class="nav-link" href="{% url 'user' %}">Profile</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'user' %}#global-parties"><i
                                class="fas fa-globe me-1"></i>Global Parties</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'join_watch_party' %}"><i
                                class="fas fa-users me-1"></i>Join Party</a></li>

                    <!-- Desktop Profile Dropdown -->
                    <li class="nav-item dropdown d-none d-lg-block">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                            data-bs-toggle="dropdown">
                            <div class="profile-icon-placeholder d-flex align-items-center justify-content-center bg-danger text-white rounded-circle"
                                style="width: 32px; height: 32px; font-size: 0.8rem;">
                                <i class="fas fa-user"></i>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark p-2"
                            style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
                            <li><a class="dropdown-item rounded-2 text-white" href="{% url 'user' %}"><i
                                        class="fas fa-user me-2"></i>Profile</a></li>
                            <li>
                                <hr class="dropdown-divider border-secondary">
                            </li>
                            <li><a class="dropdown-item text-danger rounded-2" href="{% url 'logout' %}"><i
                                        class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                    <li class="nav-item d-lg-none">
                        <a class="nav-link text-danger" href="{% url 'logout' %}">Logout</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-danger text-white px-4 rounded-pill ms-lg-2"
                            style="background-color: #e50914; border: none; font-weight: 600;"
                            href="{% url 'signup' %}">Sign Up</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    {% block content %}

    <div id="heroCarousel" class="carousel slide fade-in" data-bs-ride="carousel">
        <div class="carousel-inner">

            <div class="carousel-item active">
                <div class="hero-section"
                    style="background-image:url('https://www.sonypictures.com/sites/default/files/banner-images/2023-12/breakingbad_banner_2572x1100.jpg');">
                    <div class="hero-content">
                        <h1>Breaking Bad</h1>
                        <p class="lead mb-4">A high school chemistry teacher diagnosed with inoperable lung cancer turns
                            to manufacturing and selling methamphetamine in order to secure his family's future.</p>
                        <a href="{% url 'detail' 'tt0903747' %}" class="btn btn-danger btn-lg px-5 rounded-pill"><i
                                class="fas fa-play me-2"></i>Watch
                            Now</a>
                    </div>
                </div>
            </div>

            <div class="carousel-item">
                <div class="hero-section"
                    style="background-image:url('https://mir-s3-cdn-cf.behance.net/project_modules/fs/415b2e58808319.5bf89df796f80.jpg');">
                    <div class="hero-content">
                        <h1>Stranger Things</h1>
                        <p class="lead mb-4">When a young boy disappears, his mother, a police chief and his friends
                            must confront terrifying supernatural forces in order to get him back.</p>
                        <a href="{% url 'detail' 'tt0944947' %}" class="btn btn-danger btn-lg px-5 rounded-pill"><i
                                class="fas fa-play me-2"></i>Watch
                            Now</a>
                    </div>
                </div>
            </div>

            <div class="carousel-item">
                <div class="hero-section" style="background-image:url('https://wallpaperaccess.com/full/1091809.png');">
                    <div class="hero-content">
                        <h1>Rick and Morty</h1>
                        <p class="lead mb-4">An animated series that follows the exploits of a super scientist and his
                            not-so-bright grandson.</p>
                        <a href="{% url 'detail' 'tt3032476' %}" class="btn btn-danger btn-lg px-5 rounded-pill"><i
                                class="fas fa-play me-2"></i>Watch
                            Now</a>
                    </div>
                </div>
            </div>

            <div class="carousel-item">
                <div class="hero-section"
                    style="background-image:url('https://images.unsplash.com/photo-1485846234645-a62644f84728?q=80&w=2059&auto=format&fit=crop');">
                    <div class="hero-content">
                        <div class="badge bg-danger mb-3 px-3 py-2 rounded-pill shadow-sm">NEW FEATURE</div>
                        <h1 class="display-3 fw-bold">Global Watch Parties</h1>
                        <p class="lead mb-4">Join active public rooms and watch with people from around the world. No
                            invite
                            needed!</p>
                        <div class="d-flex gap-3">
                            <a href="{% url 'user' %}#global-parties"
                                class="btn btn-danger btn-lg px-5 rounded-pill shadow-lg border-0"
                                style="background: linear-gradient(45deg, #e50914, #ff00cc);"><i
                                    class="fas fa-globe me-2"></i>Discover Now</a>
                            <a href="{% url 'base' %}"
                                class="btn btn-outline-light btn-lg px-5 rounded-pill backdrop-blur"><i
                                    class="fas fa-users me-2"></i>Host a Public Room</a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Recently Released Movies Scroller -->
    <div class="container-fluid mt-5 px-4">
        <h2 class="section-header">RECENTLY RELEASED</h2>
        <div class="carousel-container" data-category="recent_movies" data-page="1">
            <div class="carousel-scroll">
                {% for movie in recent_movies %}
                <div class="movie-unit fade-in visible">
                    <div class="premium-card">
                        <img src="{{ movie.Poster }}" alt="{{ movie.Title }}" loading="lazy"
                            onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
                        <div class="premium-overlay">
                            <a href="{% url 'detail' movie.imdbID %}" class="premium-btn premium-btn-play">
                                <i class="fas fa-play me-2"></i>Play
                            </a>
                            <a href="javascript:void(0);" onclick="openPrivacyModal('{{ movie.imdbID }}')"
                                class="premium-btn premium-btn-play"
                                style="background: linear-gradient(45deg, #ff00cc, #333399);">
                                <i class="fas fa-users me-2"></i>Party
                            </a>
                            {% if movie.imdbID in watchlist_ids %}
                            <form method="POST" action="{% url 'remove_from_watchlist' movie.imdbID %}"
                                class="d-inline w-100">
                                {% csrf_token %}
                                <button type="submit" class="premium-btn premium-btn-remove">
                                    <i class="fas fa-times me-2"></i>Remove
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{% url 'add_to_watchlist' %}" class="d-inline w-100">
                                {% csrf_token %}
                                <input type="hidden" name="imdb_id" value="{{ movie.imdbID }}">
                                <input type="hidden" name="title" value="{{ movie.Title }}">
                                <input type="hidden" name="year" value="{{ movie.Year }}">
                                <input type="hidden" name="poster" value="{{ movie.Poster }}">
                                <button type="submit" class="premium-btn premium-btn-list">
                                    <i class="fas fa-plus me-2"></i>My List
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    <div class="media-info text-center">
                        <div class="media-title">{{ movie.Title }}</div>
                        <div class="media-meta">{{ movie.Year }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Popular Movies Scroller -->
    <div class="container-fluid mt-5 px-4">
        <h2 class="section-header">POPULAR MOVIES</h2>
        <div class="carousel-container" data-category="popular_movies" data-page="1">
            <div class="carousel-scroll">
                {% for movie in movies %}
                <div class="movie-unit fade-in visible">
                    <div class="premium-card">
                        <img src="{{ movie.Poster }}" alt="{{ movie.Title }}" loading="lazy"
                            onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
                        <div class="premium-overlay">
                            <a href="{% url 'detail' movie.imdbID %}" class="premium-btn premium-btn-play">
                                <i class="fas fa-play me-2"></i>Play
                            </a>
                            <a href="javascript:void(0);" onclick="openPrivacyModal('{{ movie.imdbID }}')"
                                class="premium-btn premium-btn-play"
                                style="background: linear-gradient(45deg, #ff00cc, #333399);">
                                <i class="fas fa-users me-2"></i>Party
                            </a>
                            {% if movie.imdbID in watchlist_ids %}
                            <form method="POST" action="{% url 'remove_from_watchlist' movie.imdbID %}"
                                class="d-inline w-100">
                                {% csrf_token %}
                                <button type="submit" class="premium-btn premium-btn-remove">
                                    <i class="fas fa-times me-2"></i>Remove
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{% url 'add_to_watchlist' %}" class="d-inline w-100">
                                {% csrf_token %}
                                <input type="hidden" name="imdb_id" value="{{ movie.imdbID }}">
                                <input type="hidden" name="title" value="{{ movie.Title }}">
                                <input type="hidden" name="year" value="{{ movie.Year }}">
                                <input type="hidden" name="poster" value="{{ movie.Poster }}">
                                <button type="submit" class="premium-btn premium-btn-list">
                                    <i class="fas fa-plus me-2"></i>My List
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    <div class="media-info text-center">
                        <div class="media-title">{{ movie.Title }}</div>
                        <div class="media-meta">{{ movie.Year }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Popular Shows Scroller -->
    <div class="container-fluid mt-5 px-4">
        <h2 class="section-header">POPULAR SHOWS</h2>
        <div class="carousel-container" data-category="home_shows" data-page="1">
            <div class="carousel-scroll">
                {% for show in shows %}
                <div class="movie-unit fade-in visible">
                    <div class="premium-card">
                        <img src="{{ show.Poster|default:'https://critics.io/img/movies/poster-placeholder.png' }}"
                            alt="{{ show.Title }}" loading="lazy"
                            onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
                        <div class="premium-overlay">
                            <a href="{% url 'detail' show.imdbID %}" class="premium-btn premium-btn-play">
                                <i class="fas fa-play me-2"></i>Play
                            </a>
                            <a href="javascript:void(0);" onclick="openPrivacyModal('{{ show.imdbID }}')"
                                class="premium-btn premium-btn-play"
                                style="background: linear-gradient(45deg, #ff00cc, #333399);">
                                <i class="fas fa-users me-2"></i>Party
                            </a>
                            {% if show.imdbID in watchlist_ids %}
                            <form method="POST" action="{% url 'remove_from_watchlist' show.imdbID %}"
                                class="d-inline w-100">
                                {% csrf_token %}
                                <button type="submit" class="premium-btn premium-btn-remove">
                                    <i class="fas fa-times me-2"></i>Remove
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{% url 'add_to_watchlist' %}" class="d-inline w-100">
                                {% csrf_token %}
                                <input type="hidden" name="imdb_id" value="{{ show.imdbID }}">
                                <input type="hidden" name="title" value="{{ show.Title }}">
                                <input type="hidden" name="year" value="{{ show.Year }}">
                                <input type="hidden" name="poster" value="{{ show.Poster }}">
                                <button type="submit" class="premium-btn premium-btn-list">
                                    <i class="fas fa-plus me-2"></i>My List
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    <div class="media-info text-center">
                        <div class="media-title">{{ show.Title }}</div>
                        <div class="media-meta">{{ show.Year }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Popular Anime Scroller -->
    <div class="container-fluid mt-5 mb-5 px-4">
        <h2 class="section-header">POPULAR ANIME</h2>
        <div class="carousel-container" data-category="popular_anime" data-page="1">
            <div class="carousel-scroll">
                {% for anime in Animes %}
                <div class="movie-unit fade-in visible">
                    <div class="premium-card">
                        <img src="{{ anime.Poster }}" alt="{{ anime.Title }}" loading="lazy"
                            onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
                        <div class="premium-overlay">
                            <a href="{% url 'detail' anime.imdbID %}" class="premium-btn premium-btn-play">
                                <i class="fas fa-play me-2"></i>Play
                            </a>
                            <a href="javascript:void(0);" onclick="openPrivacyModal('{{ anime.imdbID }}')"
                                class="premium-btn premium-btn-play"
                                style="background: linear-gradient(45deg, #ff00cc, #333399);">
                                <i class="fas fa-users me-2"></i>Party
                            </a>
                            {% if anime.imdbID in watchlist_ids %}
                            <form method="POST" action="{% url 'remove_from_watchlist' anime.imdbID %}"
                                class="d-inline w-100">
                                {% csrf_token %}
                                <button type="submit" class="premium-btn premium-btn-remove">
                                    <i class="fas fa-times me-2"></i>Remove
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{% url 'add_to_watchlist' %}" class="d-inline w-100">
                                {% csrf_token %}
                                <input type="hidden" name="imdb_id" value="{{ anime.imdbID }}">
                                <input type="hidden" name="title" value="{{ anime.Title }}">
                                <input type="hidden" name="year" value="{{ anime.Year }}">
                                <input type="hidden" name="poster" value="{{ anime.Poster }}">
                                <button type="submit" class="premium-btn premium-btn-list">
                                    <i class="fas fa-plus me-2"></i>My List
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    <div class="media-info text-center">
                        <div class="media-title">{{ anime.Title }}</div>
                        <div class="media-meta">{{ anime.Year }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% endblock %}

    <!-- Free Trial Modal -->
    <div id="trialModal" class="trial-modal">
        <div class="trial-modal-content" style="position: relative;">
            <button type="button"
                style="position: absolute; top: 10px; right: 10px; z-index: 20; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.8; transition: opacity 0.2s;"
                onclick="document.getElementById('trialModal').style.display='none'; document.body.style.overflow='auto';"
                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                <i class="fas fa-times"></i>
            </button>
            <h2>üé¨ Your Free Trial Has Ended</h2>
            <p>You've enjoyed 45 minutes of free browsing! Sign up now to continue watching unlimited movies, shows, and
                anime.</p>
            <div class="trial-timer">
                Trial Expired ‚è∞
            </div>
            <div class="trial-modal-buttons">
                <button class="trial-btn-signup" onclick="window.location.href='{% url 'signup' %}';">
                    <i class="fas fa-user-plus"></i> Sign Up Free
                </button>
                <button class="trial-btn-login" onclick="window.location.href='{% url 'login' %}';">
                    <i class="fas fa-sign-in-alt"></i> Already Have Account?
                </button>
            </div>
        </div>
    </div>

    <footer class="text-center py-4 text-muted border-top border-secondary mt-5">
        <div class="container">
            <p class="mb-0">¬© 2024 WATCHIT. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Privacy Selection Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-glow text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title fw-bold"><i class="fas fa-shield-alt text-danger me-2"></i>Choose Room
                        Privacy</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="privacy-option private p-3 rounded-4 border border-secondary cursor-pointer"
                                onclick="selectPrivacy(true)">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="icon-box bg-danger rounded-circle d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 50px;">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1 fw-bold">Private Room</h5>
                                        <p class="small text-white-50 mb-0">Only people with the code can join.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="privacy-option public p-3 rounded-4 border border-secondary cursor-pointer"
                                onclick="selectPrivacy(false)">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="icon-box bg-primary rounded-circle d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 50px;">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1 fw-bold">Public Room</h5>
                                        <p class="small text-white-50 mb-0">Visible to everyone on the platform.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .glass-panel {
            background-color: #000 !important;
            background-image: linear-gradient(145deg, rgba(30, 30, 30, 0.98), rgba(10, 10, 10, 0.99)) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }

        .privacy-option {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            cursor: pointer;
        }

        .privacy-option:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
        }

        .privacy-option.private:hover {
            border-color: #E50914 !important;
            box-shadow: 0 0 20px rgba(229, 9, 20, 0.3);
        }

        .privacy-option.public:hover {
            border-color: #00d2ff !important;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
        }

        #privacyModal .modal-content,
        #privacyModal h5,
        #privacyModal p {
            color: white !important;
        }

        .icon-box {
            transition: transform 0.3s ease;
        }

        .privacy-option:hover .icon-box {
            transform: scale(1.1);
        }
    </style>

    <script>
        let currentImdbId = null;
        function openPrivacyModal(imdbId) {
            currentImdbId = imdbId;
            const modal = new bootstrap.Modal(document.getElementById('privacyModal'));
            modal.show();
        }

        function selectPrivacy(isPrivate) {
            if (currentImdbId) {
                window.location.href = `/party/create/${currentImdbId}/?is_private=${isPrivate}`;
            }
        }
    </script>

    <script>
        const searchIcon = document.querySelector(".search-icon");
        const searchBox = document.querySelector(".search-box");

        if (searchIcon) {
            searchIcon.addEventListener("click", () => {
                searchBox.classList.toggle("active");
                if (searchBox.classList.contains("active")) {
                    document.querySelector(".search-input").focus();
                }
            });
        }

        // Free Trial Timer (45 minutes for anonymous users)
        {% if not user.is_authenticated and request.path != '/accounts/login/' and request.path != '/signup/' and '/verify/' not in request.path and '/reset-password/' not in request.path and request.path != '/forgot-password/' %}
        (function () {
            const TRIAL_DURATION = 45 * 60 * 1000; // 45 minutes in milliseconds

            // Initialize trial start time in localStorage
            let trialStart = localStorage.getItem('trial_start_time');
            if (!trialStart) {
                trialStart = Date.now();
                localStorage.setItem('trial_start_time', trialStart);
            }

            function checkTrialStatus() {
                const trialStart = parseInt(localStorage.getItem('trial_start_time'));
                const elapsed = Date.now() - trialStart;
                const remaining = TRIAL_DURATION - elapsed;

                if (remaining <= 0) {
                    // Trial expired - show modal
                    showTrialModal();
                }
            }

            function showTrialModal() {
                const modal = document.getElementById('trialModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden'; // Prevent scrolling
                }
            }

            // Check immediately on load
            checkTrialStatus();

            // Check every minute
            setInterval(checkTrialStatus, 60000);
        })();
        {% endif %}

        // Lazy Loading & Caching Logic
        document.addEventListener("DOMContentLoaded", function () {
            const containers = document.querySelectorAll('.carousel-container');

            containers.forEach(container => {
                const scrollContainer = container.querySelector('.carousel-scroll');
                let isLoading = false;
                let hasNext = true;

                scrollContainer.addEventListener('scroll', () => {
                    if (isLoading || !hasNext) return;

                    // Check if scrolled near end (within 300px)
                    if (scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 300) {
                        loadMore(container);
                    }
                });

                async function loadMore(container) {
                    if (isLoading || !hasNext) return;
                    isLoading = true;
                    startLoading(20);

                    const category = container.getAttribute('data-category');
                    let page = parseInt(container.getAttribute('data-page')) + 1;

                    // Cache Key Strategy: watchit_cache_{category}_{page}
                    const cacheKey = `watchit_cache_${category}_${page}`;
                    const cachedData = getCachedData(cacheKey);

                    if (cachedData) {
                        console.log(`Loading ${category} page ${page} from cache`);
                        const renderType = container.getAttribute('data-render-type');
                        appendItems(scrollContainer, cachedData, renderType);
                        container.setAttribute('data-page', page);
                        isLoading = false;
                        return;
                    }

                    // Fetch from API
                    console.log(`Fetching ${category} page ${page} from API`);
                    try {
                        const response = await fetch(`/fetch-more/?category=${category}&page=${page}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.items.length > 0) {
                                const renderType = container.getAttribute('data-render-type');
                                appendItems(scrollContainer, data.items, renderType);
                                container.setAttribute('data-page', page);
                                setCachedData(cacheKey, data.items);
                                hasNext = data.has_next;
                            } else {
                                hasNext = false;
                            }
                        } else {
                            console.error('Fetch error:', response.status);
                            hasNext = false;
                        }
                    } catch (error) {
                        console.error('Network error:', error);
                    } finally {
                        isLoading = false;
                        finishLoading();
                    }
                }

                function appendItems(container, items, renderType) {
                    const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                    const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'movie-unit fade-in visible';
                        div.innerHTML = `
                            <div class="premium-card">
                                <img src="${item.Poster}" alt="${item.Title}" loading="lazy"
                                     onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
                                <div class="premium-overlay">
                                    <a href="/watch/${item.imdbID}/" class="premium-btn premium-btn-play">
                                        <i class="fas fa-play me-2"></i>Play
                                    </a>
                                    <a href="javascript:void(0);" onclick="openPrivacyModal('${item.imdbID}')" class="premium-btn premium-btn-play" 
                                       style="background: linear-gradient(45deg, #ff00cc, #333399);">
                                        <i class="fas fa-users me-2"></i>Party
                                    </a>
                                    <form method="POST" action="{% url 'add_to_watchlist' %}" class="d-inline w-100">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                        <input type="hidden" name="imdb_id" value="${item.imdbID}">
                                        <input type="hidden" name="title" value="${item.Title}">
                                        <input type="hidden" name="year" value="${item.Year}">
                                        <input type="hidden" name="poster" value="${item.Poster}">
                                        <button type="submit" class="premium-btn premium-btn-list">
                                            <i class="fas fa-plus me-2"></i>My List
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="media-info text-center">
                                <div class="media-title">${item.Title}</div>
                                <div class="media-meta">${item.Year}</div>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            });
        });

        // LocalStorage Wrapper with Expiry
        function setCachedData(key, data) {
            const expiry = Date.now() + 86400000; // 24 hours
            const payload = {
                value: data,
                expiry: expiry
            };
            localStorage.setItem(key, JSON.stringify(payload));
        }

        function getCachedData(key) {
            const itemStr = localStorage.getItem(key);
            if (!itemStr) return null;

            const item = JSON.parse(itemStr);
            const now = Date.now();

            if (now > item.expiry) {
                localStorage.removeItem(key);
                return null;
            }
            return item.value;
        }

        // VPN Modal Logic - Show once per session
        document.addEventListener('DOMContentLoaded', function () {
            if (!sessionStorage.getItem('vpnModalShown')) {
                // Small delay to not overwhelm immediate load
                setTimeout(() => {
                    const vpnModal = new bootstrap.Modal(document.getElementById('vpnModal'));
                    vpnModal.show();
                    sessionStorage.setItem('vpnModalShown', 'true');
                }, 2000);
            }
        });

        // Global Loading Bar Logic
        const bar = document.getElementById('loading-bar');
        let loadingInterval;

        window.startLoading = function (initialWidth = 10) {
            if (loadingInterval) clearInterval(loadingInterval);
            bar.style.opacity = '1';
            bar.style.width = initialWidth + '%';

            let currentWidth = initialWidth;
            loadingInterval = setInterval(() => {
                if (currentWidth < 90) {
                    // Smoother increments at faster interval
                    currentWidth += (90 - currentWidth) * 0.02;
                } else {
                    currentWidth += 0.05;
                }
                bar.style.width = Math.min(currentWidth, 99) + '%';
            }, 100); // 100ms for high-frequency updates
        };

        window.finishLoading = function () {
            if (loadingInterval) clearInterval(loadingInterval);
            bar.style.width = '100%';

            // Speed up the disappearance
            setTimeout(() => {
                bar.style.opacity = '0';
                setTimeout(() => {
                    bar.style.width = '0%';
                    bar.style.opacity = '1';
                }, 300);
            }, 100);
        };

        (function () {
            // Universal click listener for all links and buttons
            document.addEventListener('click', (e) => {
                const target = e.target.closest('a, button');
                if (!target) return;

                if (target.tagName === 'A') {
                    const href = target.getAttribute('href');
                    const isSamePage = href && (href.startsWith('#') || href.startsWith('javascript:'));
                    const isNewTab = target.target === '_blank';

                    if (href && !isSamePage && !isNewTab && !e.ctrlKey && !e.metaKey) {
                        startLoading(15);
                    }
                } else if (target.tagName === 'BUTTON') {
                    if (target.type === 'submit' || target.closest('form')) {
                        startLoading(20);
                    }
                }
            });

            // Form submission listener
            document.addEventListener('submit', () => {
                startLoading(25);
            });

            // Page load completion
            if (document.readyState === 'complete') {
                finishLoading();
            } else {
                window.addEventListener('load', finishLoading);
            }

            // Detach on back/forward or fast-navigation
            window.addEventListener('pageshow', (event) => {
                if (event.persisted) {
                    finishLoading();
                }
            });
        })();
    </script>

    <style>
        .glass-panel {
            background-color: #000 !important;
            background-image: linear-gradient(145deg, rgba(30, 30, 30, 0.98), rgba(10, 10, 10, 0.99)) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }

        .privacy-option {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .privacy-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #e50914 !important;
            transform: translateY(-5px);
        }

        #privacyModal .modal-content,
        #privacyModal h5,
        #privacyModal p {
            color: white !important;
        }
    </style>
</body>

</html>