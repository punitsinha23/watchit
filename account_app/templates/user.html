{% load static %}
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WATCHIT | Profile</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700&family=Oswald:wght@200..700&display=swap"
    rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">


</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top shadow-sm" style="border-bottom: 1px solid #333;">
    <div class="container-fluid px-lg-4 d-flex align-items-center">
      <a class="navbar-brand" href="{% url 'base' %}">WATCHIT</a>

      <!-- Search Bar - Always Visible -->
      <div class="ms-auto me-2">
        <form method="POST" action="{% url 'user_dashboard' %}" class="search-box">
          {% csrf_token %}
          <i class="fa fa-search search-icon"></i>
          <input class="search-input" type="text" name="title" placeholder="Search...">
        </form>
      </div>

      <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link" href="{% url 'join_watch_party' %}"><i
                class="fas fa-users me-1"></i>Join Party</a></li>

          <!-- Mobile Profile Options -->
          <li class="nav-item d-lg-none">
            <a class="nav-link" href="{% url 'user' %}">Profile</a>
          </li>

          <!-- Desktop Profile Dropdown -->
          <li class="nav-item dropdown d-none d-lg-block">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
              data-bs-toggle="dropdown">
              <div
                class="profile-icon-placeholder d-flex align-items-center justify-content-center bg-danger text-white rounded-circle"
                style="width: 32px; height: 32px; font-size: 0.8rem;">
                <i class="fas fa-user"></i>
              </div>
            </a>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark p-2"
              style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
              <li><a class="dropdown-item rounded-2 text-white" href="{% url 'user' %}"><i
                    class="fas fa-user me-2"></i>Profile</a></li>
              <li>
                <hr class="dropdown-divider border-secondary">
              </li>
              <li><a class="dropdown-item text-danger rounded-2" href="{% url 'logout' %}"><i
                    class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
            </ul>
          </li>
          <li class="nav-item d-lg-none">
            <a class="nav-link text-danger" href="{% url 'logout' %}">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  {% if messages %}
  <div class="container mt-4">
    {% for message in messages %}
    <div
      class="alert alert-{{ message.tags }} alert-dismissible fade show bg-dark text-white border-{{ message.tags }}">
      {{ message }}
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <main class="container-fluid profile-main">
    {% block content %}
    <div class="container-fluid mt-5 text-center">
      <h1 class="display-5 fw-bold mb-4">
        Welcome <span class="text-danger">{{ display_name }}</span>
      </h1>

      <!-- FEATURE GUIDE HERO -->
      <div class="row justify-content-center mb-5 fade-in" style="animation-delay: 0.2s;">
        <div class="col-lg-10">
          <div
            class="premium-hero p-5 rounded-4 shadow-lg text-start position-relative overflow-hidden excellence-card">

            <div class="row align-items-center">
              <div class="col-md-7">
                <h2 class="display-6 fw-bold mb-3 text-white">Host Watch Parties</h2>
                <p class="lead text-white-50 mb-4">Host public sessions or join global parties instantly.</p>

                <div class="d-flex flex-column gap-4 mb-4">
                  <div class="guide-step d-flex align-items-center gap-3">
                    <div
                      class="step-blob d-flex align-items-center justify-content-center rounded-circle bg-danger text-white shadow"
                      style="width: 44px; height: 44px; flex-shrink: 0;">
                      <i class="fas fa-search-plus"></i>
                    </div>
                    <div>
                      <h5 class="mb-0 fw-bold">1. Find Your Movie</h5>
                      <p class="small text-white-50 mb-0">Browse our library and hit the <span
                          class="badge bg-danger">Party</span> button.</p>
                    </div>
                  </div>

                  <div class="guide-step d-flex align-items-center gap-3">
                    <div
                      class="step-blob d-flex align-items-center justify-content-center rounded-circle bg-danger text-white shadow"
                      style="width: 44px; height: 44px; flex-shrink: 0;">
                      <i class="fas fa-share-alt"></i>
                    </div>
                    <div>
                      <h5 class="mb-0 fw-bold">2. Share the Invite</h5>
                      <p class="small text-white-50 mb-0">Room codes are auto-generated. Just send it to your friends!
                      </p>
                    </div>
                  </div>

                  <div class="guide-step d-flex align-items-center gap-3">
                    <div
                      class="step-blob d-flex align-items-center justify-content-center rounded-circle bg-danger text-white shadow"
                      style="width: 44px; height: 44px; flex-shrink: 0;">
                      <i class="fas fa-comments"></i>
                    </div>
                    <div>
                      <h5 class="mb-0 fw-bold">3. Watch & Engage</h5>
                      <p class="small text-white-50 mb-0">Real-time chat and synced playback for everyone.</p>
                    </div>
                  </div>

                  <div
                    class="guide-step d-flex align-items-center gap-3 mt-2 pt-3 border-top border-secondary border-opacity-25">
                    <div
                      class="step-blob d-flex align-items-center justify-content-center rounded-circle bg-danger text-white shadow"
                      style="width: 44px; height: 44px; flex-shrink: 0;">
                      <i class="fas fa-globe"></i>
                    </div>
                    <div>
                      <h5 class="mb-0 fw-bold">Join the Global Community</h5>
                      <p class="small text-white-50 mb-0">You can also join <strong>Global Public Parties</strong>
                        hosted by others without needing an invite code!</p>
                    </div>
                  </div>
                </div>

                <a href="{% url 'base' %}"
                  class="btn btn-danger btn-lg rounded-pill px-5 py-3 shadow-lg fw-bold transition-all"
                  style="box-shadow: 0 0 20px rgba(229, 9, 20, 0.4) !important;">
                  <i class="fas fa-play-circle me-2"></i>Start Browsing
                </a>
              </div>

              <div class="col-md-5 d-none d-md-block text-center position-relative">
                <div class="hero-graphic position-relative" style="z-index: 2;">
                  <div class="floating-tv">
                    <i class="fas fa-tv fa-8x text-danger opacity-25"></i>
                    <div class="glow-effect"></div>
                  </div>
                  <i class="fas fa-comments position-absolute pulse"
                    style="top: 0; right: 20%; font-size: 3rem; color: #ff00cc; opacity: 0.6;"></i>
                  <i class="fas fa-bolt position-absolute jump"
                    style="bottom: 10%; left: 15%; font-size: 2.5rem; color: #ffcc00; opacity: 0.4;"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIVE ROOMS SECTION -->
    {% if hosted_parties or joined_parties %}
    <section class="fade-in mb-5" style="animation-delay: 0.4s;">
      <div class="d-flex align-items-center justify-content-between mb-4 px-3">
        <h2 class="section-title mb-0"><i class="fas fa-broadcast-tower me-3"></i>Active Live Rooms</h2>
        <span class="badge rounded-pill bg-danger shadow-sm px-3 py-2">LIVE NOW</span>
      </div>

      {% if not public_parties %}
      <div class="px-3 mb-3">
        <div class="alert alert-dark border-secondary bg-black-20 rounded-4 d-flex align-items-center gap-3 py-3">
          <div class="icon-blob bg-danger text-white rounded-circle d-flex align-items-center justify-content-center"
            style="width: 40px; height: 40px; flex-shrink: 0;">
            <i class="fas fa-globe"></i>
          </div>
          <div>
            <p class="mb-0 fw-bold text-white">No global party available, make one!</p>
            <p class="small text-white-50 mb-0">Host a public room to let others join you.</p>
          </div>
        </div>
      </div>
      {% endif %}
      <div class="carousel-container mt-4">
        <div class="carousel-scroll">
          {% for party in hosted_parties %}
          <div class="movie-unit">
            <div class="premium-card excellence-card">
              <img
                src="{% if party.poster_url and party.poster_url != 'N/A' %}{{ party.poster_url }}{% else %}https://critics.io/img/movies/poster-placeholder.png{% endif %}"
                alt="{{ party.movie_title|default:'Room' }}" loading="lazy"
                onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
              <div class="premium-overlay flex-column">
                <div class="host-badge mb-auto mt-2">HOST</div>
                <a href="{% url 'party_room' party.room_code %}" class="premium-btn premium-btn-play w-100 mb-2">
                  <i class="fas fa-sign-in-alt me-2"></i>Enter Room
                </a>
                <form method="POST" action="{% url 'delete_party' party.room_code %}" class="w-100 no-loading"
                  onsubmit="return confirm('Permanently delete this room?')">
                  {% csrf_token %}
                  <button type="submit" class="premium-btn premium-btn-danger">
                    <i class="fas fa-trash-alt me-2"></i>Close Room
                  </button>
                </form>
              </div>
            </div>
            <div class="media-info text-center mt-3">
              <div class="media-title highlighted-text">{{ party.movie_title|default:party.room_code }}</div>
              <div class="media-meta text-uppercase tracking-wider">
                CODE: {{ party.room_code }}
                {% if party.is_private %}
                <span class="ms-2" title="Private Room"><i class="fas fa-lock text-danger small"></i></span>
                {% else %}
                <span class="ms-2" title="Global Room"><i class="fas fa-globe text-primary small"></i></span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
          {% for party in joined_parties %}
          <div class="movie-unit">
            <div class="premium-card excellence-card">
              <img
                src="{% if party.poster_url and party.poster_url != 'N/A' %}{{ party.poster_url }}{% else %}https://critics.io/img/movies/poster-placeholder.png{% endif %}"
                alt="{{ party.movie_title|default:'Room' }}" loading="lazy"
                onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
              <div class="premium-overlay flex-column p-4 text-center">
                <span class="badge bg-secondary mb-3 rounded-pill">GUEST</span>
                <div class="mb-4">
                  <div class="room-code-display h4 fw-bold text-white mb-1">{{ party.room_code }}</div>
                  <small class="text-white-50">Host: {{ party.host.username }}</small>
                </div>
                <a href="{% url 'party_room' party.room_code %}" class="premium-btn premium-btn-play w-100 py-2">
                  <i class="fas fa-bolt me-2"></i>Rejoin
                </a>
              </div>
            </div>
            <div class="media-info text-center mt-3">
              <div class="media-title">{{ party.movie_title|default:party.room_code }}</div>
              <div class="media-meta">
                W/ {{ party.host.username|upper }}
                {% if party.is_private %}
                <span class="ms-2" title="Private Room"><i class="fas fa-lock text-danger small"></i></span>
                {% else %}
                <span class="ms-2" title="Global Room"><i class="fas fa-globe text-primary small"></i></span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- GLOBAL PUBLIC PARTIES SECTION -->
    {% if public_parties %}
    <section id="global-parties" class="fade-in mb-5" style="animation-delay: 0.5s;">
      <div class="d-flex align-items-center justify-content-between mb-4 px-3">
        <h2 class="section-title mb-0"><i class="fas fa-globe me-3"></i>Global Watch Parties</h2>
        <span class="badge rounded-pill bg-primary shadow-sm px-3 py-2">DISCOVER</span>
      </div>
      <div class="carousel-container mt-4">
        <div class="carousel-scroll">
          {% for party in public_parties %}
          <div class="movie-unit">
            <div class="premium-card excellence-card">
              <img
                src="{% if party.poster_url and party.poster_url != 'N/A' %}{{ party.poster_url }}{% else %}https://critics.io/img/movies/poster-placeholder.png{% endif %}"
                alt="{{ party.movie_title|default:'Room' }}" loading="lazy"
                onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
              <div class="premium-overlay flex-column p-4 text-center">
                <span class="badge bg-danger mb-3 rounded-pill">PUBLIC</span>
                <div class="mb-4">
                  <div class="media-title h5 fw-bold text-white mb-1">{{ party.movie_title|default:party.room_code }}
                  </div>
                  <small class="text-white-50">Host: {{ party.host.username }}</small>
                </div>
                <a href="{% url 'party_room' party.room_code %}" class="premium-btn premium-btn-play w-100 py-2">
                  <i class="fas fa-sign-in-alt me-2"></i>Join Party
                </a>
              </div>
            </div>
            <div class="media-info text-center mt-3">
              <div class="media-title">{{ party.movie_title|default:party.room_code }}</div>
              <div class="media-meta">W/ {{ party.host.username|upper }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- WATCHLIST SECTION -->
    <section class="fade-in mb-5" style="animation-delay: 0.6s;">
      <div class="d-flex align-items-center justify-content-between mb-4 px-3">
        <h2 class="section-title mb-0"><i class="fas fa-layer-group me-3"></i>My Collection</h2>
        <a href="{% url 'base' %}" class="btn btn-outline-light btn-sm rounded-pill px-3">View All <i
            class="fas fa-chevron-right ms-1"></i></a>
      </div>
      <div class="carousel-container mt-4">
        <div class="carousel-scroll">
          {% if watchlist %}
          {% for item in watchlist %}
          <div class="movie-unit">
            <div class="premium-card excellence-card">
              <img src="{{ item.poster }}" alt="{{ item.movie_title }}" loading="lazy"
                onerror="this.src='https://critics.io/img/movies/poster-placeholder.png'">
              <div class="premium-overlay">
                <a href="{% url 'detail' item.imdb_id %}" class="premium-btn premium-btn-play">
                  <i class="fas fa-play me-2"></i>Details
                </a>
                <a href="javascript:void(0);" onclick="openPrivacyModal('{{ item.imdb_id }}')"
                  class="premium-btn premium-btn-party py-2">
                  <i class="fas fa-users me-2"></i>Start Party
                </a>
                <form method="POST" action="{% url 'remove_from_watchlist' item.imdb_id %}"
                  class="w-100 mt-2 no-loading">
                  {% csrf_token %}
                  <button type="submit" class="premium-btn premium-btn-remove py-1">
                    <i class="fas fa-times me-2"></i>Remove
                  </button>
                </form>
              </div>
            </div>
            <div class="media-info text-center mt-3">
              <div class="media-title">{{ item.movie_title }}</div>
              <div class="media-meta">{{ item.movie_year }}</div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="p-5 text-center w-100 bg-white-10 rounded-4 border-dashed"
            style="border: 2px dashed rgba(255,255,255,0.1);">
            <i class="fas fa-plus-circle fa-3x text-white-10 mb-3" style="opacity: 0.1;"></i>
            <p class="text-secondary lead">Your cinematic collection is waiting.</p>
            <a href="{% url 'base' %}" class="text-danger fw-bold">Discover Movies Now â†’</a>
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    {% endblock %}
  </main>

  <footer class="mt-4">
    &copy; {{ year|date:"Y" }} WATCHIT. All Rights Reserved.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>
  <script>
    document.querySelector(".search-icon").addEventListener("click", function () {
      document.querySelector(".search-box").classList.toggle("active");
    });

    let currentImdbId = null;
    function openPrivacyModal(imdbId) {
      currentImdbId = imdbId;
      const modal = new bootstrap.Modal(document.getElementById('privacyModal'));
      modal.show();
    }

    function selectPrivacy(isPrivate) {
      if (currentImdbId) {
        window.location.href = `/party/create/${currentImdbId}/?is_private=${isPrivate}`;
      }
    }
  </script>

  <!-- Privacy Selection Modal -->
  <div class="modal fade" id="privacyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content glass-panel border-glow text-white">
        <div class="modal-header border-secondary">
          <h5 class="modal-title fw-bold"><i class="fas fa-shield-alt text-danger me-2"></i>Choose Room Privacy</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <div class="row g-3">
            <div class="col-12">
              <div class="privacy-option private p-3 rounded-4 border border-secondary cursor-pointer"
                onclick="selectPrivacy(true)">
                <div class="d-flex align-items-center gap-3">
                  <div class="icon-box bg-danger rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 50px; height: 50px;">
                    <i class="fas fa-lock"></i>
                  </div>
                  <div>
                    <h5 class="mb-1 fw-bold">Private Room</h5>
                    <p class="small text-white-50 mb-0">Only people with the code can join.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="privacy-option public p-3 rounded-4 border border-secondary cursor-pointer"
                onclick="selectPrivacy(false)">
                <div class="d-flex align-items-center gap-3">
                  <div class="icon-box bg-primary rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 50px; height: 50px;">
                    <i class="fas fa-globe"></i>
                  </div>
                  <div>
                    <h5 class="mb-1 fw-bold">Public Room</h5>
                    <p class="small text-white-50 mb-0">Visible to everyone on the platform.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .glass-panel {
      background-color: #000 !important;
      background-image: linear-gradient(145deg, rgba(30, 30, 30, 0.98), rgba(10, 10, 10, 0.99)) !important;
      backdrop-filter: blur(20px) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
    }

    .privacy-option {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .privacy-option:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #e50914 !important;
      transform: translateY(-5px);
    }

    #privacyModal .modal-content,
    #privacyModal h5,
    #privacyModal p {
      color: white !important;
    }

    .icon-box {
      transition: transform 0.3s ease;
    }

    .privacy-option:hover .icon-box {
      transform: scale(1.1);
    }
  </style>
</body>

</html>